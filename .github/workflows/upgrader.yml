name: Wuji Upgrader
on:
  workflow_dispatch:
    inputs:
      jobType:
        required: true
        default: fuceti_init
      plan:
        required: false
        default: "{}"
      jobId:
        required: true
      notifyURL:
        required: true
      notifyToken:
        required: true
      branch:
        required: true
        default: main

jobs:
  apply:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create module - Fuceti (最小可用頁)
        if: ${{ inputs.jobType == 'fuceti_init' }}
        run: |
          mkdir -p app/fuceti app/api/fuceti
          cat > app/fuceti/page.tsx <<'EOF'
          export default function FucetiPage(){
            return (<div className="p-6">
              <h1 className="text-xl font-semibold">富策體（最小可用）</h1>
              <p className="opacity-80 mt-2">自動升級完成。之後會接策略卡與圖表。</p>
            </div>)
          }
          EOF

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --quiet && echo "No changes" || git commit -m "chore(upgrade): apply ${{ inputs.jobType }}"
          git push origin HEAD:${{ inputs.branch }}

      - name: Notify platform done
        run: |
          curl -s -X POST "${{ inputs.notifyURL }}" \
           -H "Authorization: Bearer ${{ inputs.notifyToken }}" \
           -H "Content-Type: application/json" \
           -d "{\"jobId\":\"${{ inputs.jobId }}\",\"status\":\"done\",\"progress\":100}"
