id: r5-spec
version: v2.2.1
one_liner: "以 DB 狀態模型為唯一事實源；API 完全鏡射；外部行為由 meta 驅動。"

ssot:
  db_table: public.r5_runs
  core_fields:
    - { name: goal, type: text, nullable: false, note: "任務目的（必填）" }
    - { name: status, type: text, enum: [running, completed, failed, cancelled], note: "任務狀態" }
    - { name: step_index, type: int, default: 0 }
    - { name: progress_percent, type: numeric, default: 0 }
    - { name: total_steps, type: int|null }
    - { name: updated_at, type: timestamptz }
    - { name: meta, type: jsonb, default: {}, note: "op/ref/workflow_id/gh_run_id/total_steps..." }
    - { name: steps, type: jsonb, default: [] }
    - { name: waits, type: jsonb, default: [] }
    - { name: progress_message, type: text, default: "" }

  compat_readonly:
    - { name: state,   maps_to: status }
    - { name: step,    maps_to: step_index }
    - { name: percent, maps_to: progress_percent }

api_contract:
  openapi: "3.1.0"
  routes:
    - { method: GET,  path: /api/r5/ping,                        response: {200: SimpleOk} }
    - { method: GET,  path: /api/r5/health,                      response: {200: SimpleOk, 5XX: ErrorResponse} }
    - { method: POST, path: /api/r5/start,                       response: {200: StartResponse, 4XX: ErrorResponse, 5XX: ErrorResponse} }
    - { method: GET,  path: /api/r5/runs/{id},                   response: {200: RunStatusEnvelope, 404: ErrorResponse} }
    - { method: POST, path: /api/r5/vercel/deploy,               response: {200: DeployResponse, 5XX: ErrorResponse} }
    - { method: GET,  path: /api/r5/gh/workflows/{workflow_id}/runs, response: {200: GHListRunsResponse, 5XX: ErrorResponse} }
    - { method: GET,  path: /api/r5/gh/runs/{run_id},            response: {200: GHRunResponse, 5XX: ErrorResponse} }

connectors:
  github:
    dispatch: "POST /repos/{owner}/{repo}/actions/workflows/{workflow_id}/dispatches"
    runs:     "GET  /repos/{owner}/{repo}/actions/runs/{run_id}"
    status_map:
      queued:      { status: running,  step_index: 1, progress_percent: 30 }
      in_progress: { status: running,  step_index: 2, progress_percent: 70 }
      completed:
        success:   { status: completed, step_index: 3, progress_percent: 100 }
        cancelled: { status: cancelled, step_index: 3, progress_percent: 100 }
        failure:   { status: failed,    step_index: 3, progress_percent: 100 }

  vercel:
    deploy_hook: "POST <unique-url>"

principles:
  - "任何程式碼改動前，先讀『錯誤紀錄』『施工管線圖』最新版本。"
  - "新增欄位一律寫在 meta；核心欄位不可改名。"
  - "OpenAPI 只鏡射 DB，不引入新結構。"

acceptance:
  A1_health:
    - "GET /api/r5/ping == 200 JSON"
    - "GET /api/r5/health == 200 JSON"
  A2_db_schema:
    - "r5_runs has {status, step_index, progress_percent, total_steps, meta, goal}"
  A3_dispatch:
    - "POST /api/r5/start (op=gh_dispatch) → 200，GitHub 返回 204"
    - "GET /api/r5/runs/{id} 反映 queued/in_progress/completed"
  A4_vercel:
    - "POST /api/r5/vercel/deploy → 200/202 並觸發部署"
